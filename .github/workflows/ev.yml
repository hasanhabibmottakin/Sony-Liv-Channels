name: Auto Convert Sony Event API

on:
  schedule:
    - cron: "* * * * *"   
  workflow_dispatch:

permissions:
  contents: write

jobs:
  convert-api:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch and Convert JSON
        run: |
          echo "Fetching Sony Event JSON..."
          mkdir -p data
          curl -s "https://raw.githubusercontent.com/hasanhabibmottakin/Sony-Liv-/refs/heads/main/sony_event.json" -o data/input.json

          echo "Converting and cleaning URLs..."
          echo '{' > data/api.json
          jq -r '
            .events[] |
            .url |= sub("\\|x-playback-session-id=.*$"; "") |
            "\"\(.id)\": {\"id\": \"\(.id)\", \"title\": \"\(.name)\", \"logo\": \"\(.logo)\", \"genre\": \"\(.category)\", \"language\": \"\(.language)\", \"m3u8\": \"\(.url)\"},"
          ' data/input.json | sed '$ s/,$//' >> data/api.json
          echo '}' >> data/api.json

      - name: Commit and Push changes
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions Bot"

          if [ -n "$(git status --porcelain data/api.json)" ]; then
            git add data/api.json
            git commit -m "Auto update cleaned data/api.json"
            git push
          else
            echo "No changes detected â€” skipping commit."
          fi
